<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ad Manager Pro - Sign In / Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.min.css">
  <style>
    /* Your original CSS here - omitted for brevity, copy from previous */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #121212 100%);
      color: #d1d5db;
      min-height: 100vh;
      overflow-x: hidden;
    }
    /* ... (include all original styles: .auth-container, .form, etc., up to @media queries) */
  </style>
</head>
<body>
  <!-- Your original HTML structure here - auth forms, dashboard, modal, etc. -->
  <div class="auth-container" id="authContainer">
    <!-- Original signin/signup forms, but update onsubmit to handleSignIn/handleSignUp with GAS POST -->
  </div>

  <div class="dashboard-container hidden" id="dashboardContainer">
    <!-- Original header, main, sections -->
    <!-- In ads list, add status display and ad link after approve -->
    <div id="adsList"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const state = {
      isAuthenticated: false,
      users: [], // Local fallback
      ads: [],
      userEmail: '', // Track logged user
      userName: 'User',
      APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwSZeLHKepVJk7_dh5jIRH8_0r_s8ZCDf5nBXieq-q-pK_C4FVkIurDWPuMW0A76FnQdQ/exec',
      WORKER_URL: 'https://m-ads.mooviedsited.workers.dev'
    };

    // Updated handleSignUp
    async function handleSignUp(event) {
      event.preventDefault();
      const formData = new FormData();
      formData.append('action', 'registerUser');
      formData.append('name', document.getElementById('signupName').value);
      formData.append('email', document.getElementById('signupEmail').value);
      formData.append('business', document.getElementById('signupBusiness').value);
      formData.append('phone', document.getElementById('signupPhone').value);
      formData.append('password', document.getElementById('signupPassword').value); // Note: In prod, hash this

      try {
        const response = await fetch(state.APPS_SCRIPT_URL, { method: 'POST', body: formData });
        const result = await response.json();
        if (result.success) {
          state.isAuthenticated = true;
          state.userEmail = document.getElementById('signupEmail').value;
          state.userName = document.getElementById('signupName').value;
          showDashboard();
          fetchUserAds();
          alert('‚úÖ Account created and uploaded to GAS!');
        } else {
          alert('‚ùå Error: ' + result.error);
        }
      } catch (error) {
        alert('‚ùå Upload failed: ' + error);
      }
    }

    // Updated handleSignIn (similar, but no new user)
    async function handleSignIn(event) {
      event.preventDefault();
      const email = document.getElementById('signinEmail').value;
      const password = document.getElementById('signinPassword').value; // Validate locally or via GAS GET

      // Simple local check for demo, in prod fetch from GAS
      const user = state.users.find(u => u.email === email && u.password === password);
      if (user) {
        state.isAuthenticated = true;
        state.userEmail = email;
        state.userName = user.name;
        showDashboard();
        fetchUserAds();
        alert('‚úÖ Signed in!');
      } else {
        alert('‚ùå Invalid credentials');
      }
    }

    // New: Fetch user ads from GAS
    async function fetchUserAds() {
      try {
        const response = await fetch(`${state.APPS_SCRIPT_URL}?email=${encodeURIComponent(state.userEmail)}`);
        const result = await response.json();
        if (result.success) {
          state.ads = result.ads;
          renderAds();
          updateOverview();
          updateChart();
        }
      } catch (error) {
        console.error('Fetch ads failed:', error);
      }
    }

    // Updated uploadAd - now with slip check, POST to GAS
    async function uploadAd() {
      const title = document.getElementById('adTitle').value;
      const type = document.getElementById('adType').value;
      const duration = document.getElementById('adDuration').value;
      const url = document.getElementById('adUrl').value;
      const fileInput = document.getElementById('adFile');
      
      if (!title || !type || !duration || !url || !fileInput.files[0]) {
        alert('Please fill all fields and select file');
        return;
      }

      // Check if slip uploaded (from modal)
      if (!state.selectedSlipFile) {
        alert('Please upload payment slip first');
        openBankSlipUpload();
        return;
      }

      const formData = new FormData();
      formData.append('action', 'uploadAd');
      formData.append('email', state.userEmail);
      formData.append('name', state.userName);
      formData.append('title', title);
      formData.append('type', type);
      formData.append('duration', duration);
      formData.append('targetUrl', url);
      formData.append('business', ''); // From user
      formData.append('phone', ''); // From user

      // Ad file as base64
      const adFile = fileInput.files[0];
      const adReader = new FileReader();
      adReader.onload = async (e) => {
        formData.append('adFile', e.target.result);
        formData.append('fileExt', adFile.name.split('.').pop());
        formData.append('mimeType', adFile.type);

        // Slip file
        const slipReader = new FileReader();
        slipReader.onload = async (f) => {
          formData.append('slipFile', f.target.result);
          formData.append('slipExt', state.selectedSlipFile.name.split('.').pop());
          formData.append('slipMimeType', state.selectedSlipFile.type);

          try {
            const response = await fetch(state.APPS_SCRIPT_URL, { method: 'POST', body: formData });
            const result = await response.json();
            if (result.success) {
              alert('‚úÖ Ad uploaded to GAS - pending approval!');
              state.selectedSlipFile = null;
              // Clear form
              document.getElementById('adTitle').value = '';
              document.getElementById('adUrl').value = '';
              document.getElementById('adFile').value = '';
              document.getElementById('adType').value = '';
              document.getElementById('adDuration').value = '';
              fetchUserAds(); // Refresh
            } else {
              alert('‚ùå Upload failed: ' + result.error);
            }
          } catch (error) {
            alert('‚ùå Network error: ' + error);
          }
        };
        slipReader.readAsDataURL(state.selectedSlipFile);
      };
      adReader.readAsDataURL(adFile);
    }

    // Updated submitSlip - now part of uploadAd, but keep modal
    function submitSlip() {
      if (!state.selectedSlipFile) return alert('Select slip');
      // Now uploadAd handles it, so close modal
      closeSlipModal();
      // Optionally auto-trigger uploadAd if form ready
    }

    // Updated renderAds - show status, ad link if active
    function renderAds() {
      const adsList = document.getElementById('adsList');
      if (state.ads.length === 0) {
        adsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><h3>No Ads</h3><p>Upload your first ad</p></div>';
        return;
      }

      adsList.innerHTML = state.ads.map(ad => {
        let statusBadge = '';
        if (ad.status === 'pending') statusBadge = '<span class="status-badge status-pending">Pending</span>';
        else if (ad.status === 'active') statusBadge = `<span class="status-badge status-active">Active</span><br><a href="${state.WORKER_URL}?adId=${ad.adId}&url=${encodeURIComponent(ad.targetUrl)}" target="_blank">üìé Ad Link</a>`;
        else if (ad.status === 'rejected') statusBadge = '<span class="status-badge status-expired">Rejected</span>';
        else if (ad.status === 'expired') statusBadge = '<span class="status-badge status-expired">Expired</span>';

        const expiry = new Date(ad.endDate);
        const daysLeft = Math.ceil((expiry - new Date()) / (86400000));

        return `
          <div class="ad-card">
            <div class="ad-card-header">
              <div><div class="ad-title">${ad.title}</div>${statusBadge}</div>
              <span class="ad-type-badge">${ad.type}</span>
            </div>
            <div class="ad-stats-grid">
              <div class="stat-box"><div class="stat-label">Views</div><div class="stat-value">${ad.views}</div></div>
              <div class="stat-box"><div class="stat-label">Clicks</div><div class="stat-value">${ad.clicks}</div></div>
              <div class="stat-box"><div class="stat-label">Status</div><div class="stat-value">${ad.status}</div></div>
              <div class="stat-box"><div class="stat-label">Days Left</div><div class="stat-value">${daysLeft > 0 ? daysLeft : 0}</div></div>
            </div>
            <div class="ad-actions">
              <button class="btn btn-small btn-success" onclick="trackAd('${ad.adId}', 'view')">+ View</button>
              <button class="btn btn-small btn-success" onclick="trackAd('${ad.adId}', 'click')">+ Click</button>
              <button class="btn btn-small btn-danger" onclick="deleteAd(${state.ads.indexOf(ad)})">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // New: Track via Worker
    async function trackAd(adId, type, value = 1) {
      try {
        await fetch(state.WORKER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ adId, type, value })
        });
        fetchUserAds(); // Refresh
        alert(`Tracked ${type}!`);
      } catch (error) {
        alert('Track failed');
      }
    }

    // showDashboard
    function showDashboard() {
      document.getElementById('authContainer').classList.add('hidden');
      document.getElementById('dashboardContainer').classList.remove('hidden');
      document.querySelector('.logo-text h1').textContent = `Welcome, ${state.userName}`;
    }

    // Original functions: logout, updateChart, etc., remain the same
    function logout() {
      if (confirm('Logout?')) {
        state.isAuthenticated = false;
        state.ads = [];
        document.getElementById('dashboardContainer').classList.add('hidden');
        document.getElementById('authContainer').classList.remove('hidden');
      }
    }

    // Init
    if (localStorage.getItem('userEmail')) {
      state.userEmail = localStorage.getItem('userEmail');
      state.isAuthenticated = true;
      showDashboard();
      fetchUserAds();
    }
  </script>
</body>
</html>
