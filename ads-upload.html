<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOOVIED Ads Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Dark Galaxy Animated Background */
        body {
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            overflow-x: hidden;
            position: relative;
        }
        .stars {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1;
        }
        .star {
            position: absolute; background: white; border-radius: 50%; animation: twinkle 3s infinite alternate;
        }
        @keyframes twinkle {
            0% { opacity: 0.3; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1.3); }
        }
        .nebula {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -2;
            background: radial-gradient(circle at 50% 50%, rgba(173, 216, 230, 0.1) 0%, transparent 50%);
            animation: nebulaMove 30s linear infinite;
        }
        @keyframes nebulaMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-10%, -10%); }
        }
        /* Glassmorphism */
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .glass-card { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(15px); border: 1px solid rgba(100, 149, 237, 0.4); box-shadow: 0 10px 35px rgba(31, 38, 135, 0.4); border-radius: 20px; }
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.6s ease-out; }
        /* Progress Bar for Views */
        .views-progress { background: rgba(255, 255, 255, 0.1); border-radius: 50px; height: 10px; }
        .views-fill { background: linear-gradient(to right, #add8e6, #4169e1); border-radius: 50px; height: 100%; transition: width 0.5s ease; }
        /* Loading Spinner */
        .loading::after {
            content: ''; display: inline-block; width: 20px; height: 20px; border: 2px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; margin-left: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen text-white font-sans">
    <!-- Nebula and Stars Background -->
    <div class="nebula"></div>
    <div class="stars" id="stars"></div>
    <script>
        // Generate Blinking Stars
        function createStars() {
            const starsDiv = document.getElementById('stars');
            for (let i = 0; i < 300; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = star.style.height = Math.random() * 3 + 1 + 'px';
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.animationDuration = Math.random() * 2 + 2 + 's';
                starsDiv.appendChild(star);
            }
        }
        createStars();
    </script>
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-8 glass-card p-4 rounded-2xl">
            <h1 class="text-5xl font-bold text-lightblue-300 mb-2" style="text-shadow: 0 0 10px rgba(173,216,230,0.5);">MOOVIED Ads System</h1>
            <p class="text-gray-200 text-lg">Track Your Ad Views in Real-Time</p>
        </header>
        <!-- Login/Signup Modal -->
        <div id="authModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <div class="glass-card rounded-2xl p-8 w-full max-w-lg mx-4 fade-in">
                <div class="flex justify-end mb-4">
                    <button onclick="toggleAuth()" class="text-white hover:text-gray-300 text-2xl">&times;</button>
                </div>
                <h2 id="modalTitle" class="text-3xl font-bold mb-6 text-center text-lightblue-200">Login</h2>
                <form id="authForm">
                    <input type="hidden" id="action" value="login">
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-gray-200">Name (Signup Only)</label>
                        <input type="text" id="name" class="w-full p-3 rounded-lg glass text-white placeholder-gray-400" placeholder="Full Name" required disabled>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-gray-200">Email</label>
                        <input type="email" id="email" class="w-full p-3 rounded-lg glass text-white placeholder-gray-400" placeholder="Email" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-gray-200">Password</label>
                        <input type="password" id="password" class="w-full p-3 rounded-lg glass text-white placeholder-gray-400" placeholder="Password" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-gray-200">Phone/WhatsApp</label>
                        <input type="tel" id="phone" class="w-full p-3 rounded-lg glass text-white placeholder-gray-400" placeholder="+94..." required>
                    </div>
                    <button type="submit" id="authSubmit" class="w-full bg-blue-500 hover:bg-blue-600 p-3 rounded-lg font-bold transition duration-300">Submit</button>
                </form>
                <p class="text-center mt-4">
                    <button onclick="switchAuth()" class="text-lightblue-300 hover:underline">Switch to <span id="switchText">Signup</span></button>
                </p>
            </div>
        </div>
        <!-- Dashboard -->
        <div id="dashboard" class="hidden">
            <!-- Profile Header -->
            <div class="glass-card rounded-xl p-6 mb-6 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img id="profileImg" src="https://via.placeholder.com/60" alt="Profile" class="w-16 h-16 rounded-full border-2 border-blue-500">
                    <div>
                        <h2 id="userName" class="text-2xl font-bold text-lightblue-200">User</h2>
                        <p id="userEmail" class="text-gray-300">email@example.com</p>
                    </div>
                </div>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition duration-300">Logout</button>
            </div>
            <!-- Tabs -->
            <div class="glass-card rounded-xl p-6 mb-6">
                <div class="flex border-b border-gray-600">
                    <button onclick="showTab('ads')" class="px-6 py-3 font-bold text-lightblue-300 border-b-2 border-lightblue-500 transition duration-300">My Ads</button>
                    <button onclick="showTab('upload')" class="px-6 py-3 font-bold text-gray-200 hover:text-lightblue-300 transition duration-300">Upload Ad</button>
                    <button onclick="showTab('settings')" class="px-6 py-3 font-bold text-gray-200 hover:text-lightblue-300 transition duration-300">Settings</button>
                </div>
            </div>
            <!-- Ads Tab -->
            <div id="adsTab" class="glass-card rounded-xl p-6">
                <h3 class="text-2xl font-bold mb-4 text-lightblue-200">Your Ads - Real-Time Views</h3>
                <div id="adsList" class="space-y-6"></div>
            </div>
            <!-- Upload Tab -->
            <div id="uploadTab" class="glass-card rounded-xl p-6 hidden">
                <h3 class="text-2xl font-bold mb-4 text-lightblue-200">Upload New Ad</h3>
                <form id="uploadForm">
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-gray-200">Ad File (Video/Image)</label>
                        <input type="file" id="adFile" accept="video/*,image/*" class="w-full p-3 rounded-lg glass text-white" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-gray-200">Expiry Type</label>
                        <select id="expiryType" class="w-full p-3 rounded-lg glass text-white">
                            <option value="1month">1 Month - Rs 550</option>
                            <option value="12month">12 Months - Rs 5000</option>
                            <option value="lifetime">Lifetime - Rs 45000</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-gray-200">Bank Deposit Slip (Image)</label>
                        <input type="file" id="slipFile" accept="image/*" class="w-full p-3 rounded-lg glass text-white" required>
                    </div>
                    <button type="submit" id="uploadSubmit" class="w-full bg-green-500 hover:bg-green-600 p-3 rounded-lg font-bold transition duration-300">Upload & Submit Payment</button>
                </form>
            </div>
            <!-- Settings Tab -->
            <div id="settingsTab" class="glass-card rounded-xl p-6 hidden">
                <h3 class="text-2xl font-bold mb-4 text-lightblue-200">Profile Settings</h3>
                <form id="settingsForm">
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-gray-200">Name</label>
                        <input type="text" id="editName" class="w-full p-3 rounded-lg glass text-white" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-gray-200">Phone/WhatsApp</label>
                        <input type="tel" id="editPhone" class="w-full p-3 rounded-lg glass text-white" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-gray-200">Profile Image</label>
                        <input type="file" id="profileFile" accept="image/*" class="w-full p-3 rounded-lg glass text-white">
                    </div>
                    <button type="submit" id="settingsSubmit" class="w-full bg-blue-500 hover:bg-blue-600 p-3 rounded-lg font-bold transition duration-300">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbznhzcqZLs3WcWU2LLgoKFGy6FVwo2U2UH0zmx0cNMsqJlKLPveXNVlcb-OsSnBQc5C/exec';
        const IMGBB_API = '912bd1391e9372f65c0918e17f0ed370';
        const ADMIN_EMAIL = 'mooviedsited@gmail.com';
        const SUPPORT_WHATSAPP = '+94770342724';
        let currentUser = { email: '', name: '', deviceId: '' };
        let adsPollInterval; // For real-time polling
        // Convert file to base64
        async function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        // Toggle button loading state
        function toggleButtonLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            if (isLoading) {
                button.disabled = true;
                button.classList.add('loading');
                button.textContent = button.id === 'uploadSubmit' ? 'Uploading...' : 'Submitting...';
            } else {
                button.disabled = false;
                button.classList.remove('loading');
                button.textContent = button.id === 'uploadSubmit' ? 'Upload & Submit Payment' : button.id === 'authSubmit' ? 'Submit' : 'Save Changes';
            }
        }
        // Device ID for one-time login
        function getDeviceId() {
            let id = localStorage.getItem('deviceId');
            if (!id) {
                id = btoa(navigator.userAgent + Date.now());
                localStorage.setItem('deviceId', id);
            }
            return id;
        }
        // Check Session
        async function checkSession() {
            const savedEmail = localStorage.getItem('userEmail');
            if (savedEmail) {
                toggleButtonLoading('authSubmit', true);
                try {
                    const res = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: new URLSearchParams({ action: 'verify', email: savedEmail, deviceId: getDeviceId() })
                    });
                    const data = await res.json();
                    toggleButtonLoading('authSubmit', false);
                    if (data.success) {
                        currentUser = data.user;
                        loadUserData();
                        document.getElementById('dashboard').classList.remove('hidden');
                        document.getElementById('authModal').classList.add('hidden');
                        startAdsPolling(); // Start real-time polling
                    } else {
                        localStorage.removeItem('userEmail');
                        showAuth();
                    }
                } catch (err) {
                    toggleButtonLoading('authSubmit', false);
                    showAuth();
                }
            } else {
                showAuth();
            }
        }
        // Real-time polling for ads views
        function startAdsPolling() {
            loadAds(); // Initial load
            if (adsPollInterval) clearInterval(adsPollInterval);
            adsPollInterval = setInterval(loadAds, 10000); // Poll every 10s for real-time updates
        }
        function stopAdsPolling() {
            if (adsPollInterval) clearInterval(adsPollInterval);
        }
        // Show/Hide Auth Modal
        function showAuth() {
            document.getElementById('authModal').classList.remove('hidden');
        }
        function toggleAuth() {
            document.getElementById('authModal').classList.add('hidden');
        }
        // Switch Login/Signup
        function switchAuth() {
            const action = document.getElementById('action').value === 'login' ? 'signup' : 'login';
            document.getElementById('action').value = action;
            document.getElementById('modalTitle').textContent = action.charAt(0).toUpperCase() + action.slice(1);
            document.getElementById('name').disabled = action === 'login';
            document.getElementById('switchText').textContent = action === 'login' ? 'Signup' : 'Login';
        }
        // Auth Form Submit
        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleButtonLoading('authSubmit', true);
            const action = document.getElementById('action').value;
            const formData = new URLSearchParams({
                action,
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                phone: document.getElementById('phone').value,
                deviceId: getDeviceId()
            });
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
                const data = await res.json();
                toggleButtonLoading('authSubmit', false);
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('userEmail', currentUser.email);
                    loadUserData();
                    document.getElementById('dashboard').classList.remove('hidden');
                    toggleAuth();
                    startAdsPolling(); // Start polling on login
                } else {
                    alert(data.message || 'Authentication failed');
                }
            } catch (err) {
                toggleButtonLoading('authSubmit', false);
                alert('Network error: ' + err.message);
            }
        });
        // Load User Data
        async function loadUserData() {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            if (currentUser.profileImg) document.getElementById('profileImg').src = currentUser.profileImg;
            document.getElementById('editName').value = currentUser.name;
            document.getElementById('editPhone').value = currentUser.phone;
            await loadAds();
        }
        // Load Ads (Real-time via polling)
        async function loadAds() {
            const formData = new URLSearchParams({ action: 'get_ads', email: currentUser.email });
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
                const data = await res.json();
                const list = document.getElementById('adsList');
                list.innerHTML = data.ads.map(ad => `
                    <div class="glass p-4 rounded-lg transition duration-300 hover:shadow-lg">
                        <p class="text-lg font-bold text-lightblue-200">${ad.AdType.toUpperCase()} Ad</p>
                        <p><strong>Views:</strong> ${ad.Views} (Watched by ${ad.Views} users)</p>
                        <div class="views-progress mt-2">
                            <div class="views-fill" style="width: ${(ad.Views / 10000) * 100}%"></div>
                        </div>
                        <p><strong>Expiry:</strong> ${new Date(ad.ExpiryDate).toLocaleDateString()}</p>
                        <p><strong>Status:</strong> ${ad.Status.toUpperCase()}</p>
                        ${ad.Status === 'pending' ? `
                            <button onclick="contactSupport('${ad.ID}')" class="bg-red-500 px-4 py-2 rounded hover:bg-red-600 transition">Contact Support</button>
                        ` : ''}
                    </div>
                `).join('');
                console.log('[Dashboard] Ads updated with real-time views');
            } catch (err) {
                console.error('Load ads error:', err);
                alert('Failed to load ads');
            }
        }
        // Contact Support
        function contactSupport(adId) {
            window.open(`https://wa.me/${SUPPORT_WHATSAPP}?text=Ad ID:${adId} - Need assistance`);
        }
        // Upload Form
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const adFile = document.getElementById('adFile').files[0];
            const slipFile = document.getElementById('slipFile').files[0];
            const expiryType = document.getElementById('expiryType').value;
            if (!adFile || !slipFile) {
                alert('Please select both ad and slip files');
                return;
            }
            toggleButtonLoading('uploadSubmit', true);
            try {
                const adBase64 = await fileToBase64(adFile);
                const slipBase64 = await fileToBase64(slipFile);
                const formData = new URLSearchParams({
                    action: 'upload_ad',
                    email: currentUser.email,
                    adFileBase64: adBase64,
                    slipFileBase64: slipBase64,
                    adFileName: adFile.name,
                    slipFileName: slipFile.name,
                    expiryType
                });
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                toggleButtonLoading('uploadSubmit', false);
                if (data.success) {
                    alert('Ad uploaded successfully! Awaiting approval.');
                    document.getElementById('uploadForm').reset();
                    loadAds(); // Refresh list
                } else {
                    alert(data.message || 'Upload failed');
                }
            } catch (err) {
                toggleButtonLoading('uploadSubmit', false);
                alert('Upload error: ' + err.message);
            }
        });
        // Settings Form
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleButtonLoading('settingsSubmit', true);
            const profileFile = document.getElementById('profileFile').files[0];
            let imgUrl = currentUser.profileImg;
            if (profileFile) {
                try {
                    imgUrl = await uploadToImgBB(profileFile);
                    if (!imgUrl) {
                        toggleButtonLoading('settingsSubmit', false);
                        alert('Profile image upload failed');
                        return;
                    }
                } catch (err) {
                    toggleButtonLoading('settingsSubmit', false);
                    alert('Profile image upload error: ' + err.message);
                    return;
                }
            }
            const formData = new URLSearchParams({
                action: 'update_profile',
                email: currentUser.email,
                name: document.getElementById('editName').value,
                phone: document.getElementById('editPhone').value,
                profileImg: imgUrl
            });
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
                const data = await res.json();
                toggleButtonLoading('settingsSubmit', false);
                if (data.success) {
                    currentUser = { ...currentUser, ...data.user };
                    loadUserData();
                    alert('Profile updated!');
                } else {
                    alert('Update failed');
                }
            } catch (err) {
                toggleButtonLoading('settingsSubmit', false);
                alert('Update error: ' + err.message);
            }
        });
        // Upload to ImgBB
        async function uploadToImgBB(file) {
            const formData = new FormData();
            formData.append('image', file);
            formData.append('key', IMGBB_API);
            try {
                const res = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: formData });
                const data = await res.json();
                return data.success ? data.data.url : null;
            } catch (err) {
                console.error('ImgBB error:', err);
                throw err;
            }
        }
        // Tab Switching
        function showTab(tab) {
            document.querySelectorAll('[id$="Tab"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(tab + 'Tab').classList.remove('hidden');
            document.querySelectorAll('button[onclick^="showTab"]').forEach(btn => btn.classList.remove('text-lightblue-300', 'border-b-2', 'border-lightblue-500'));
            event.target.classList.add('text-lightblue-300', 'border-b-2', 'border-lightblue-500');
            if (tab === 'ads') loadAds();
        }
        // Logout
        function logout() {
            stopAdsPolling(); // Stop polling
            localStorage.removeItem('userEmail');
            currentUser = {};
            document.getElementById('dashboard').classList.add('hidden');
            showAuth();
        }
        // Init
        checkSession();
    </script>
</body>
</html>
