<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOOVIED Ads Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            overflow-x: hidden;
            position: relative;
        }
        .stars {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1;
        }
        .star {
            position: absolute; background: white; border-radius: 50%; animation: twinkle 3s infinite alternate;
        }
        @keyframes twinkle {
            0% { opacity: 0.3; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1.3); }
        }
        .nebula {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -2;
            background: radial-gradient(circle at 50% 50%, rgba(173, 216, 230, 0.1) 0%, transparent 50%);
            animation: nebulaMove 30s linear infinite;
        }
        @keyframes nebulaMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-10%, -10%); }
        }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .glass-card { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(15px); border: 1px solid rgba(100, 149, 237, 0.4); box-shadow: 0 10px 35px rgba(31, 38, 135, 0.4); border-radius: 20px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.6s ease-out; }
        .views-progress { background: rgba(255, 255, 255, 0.1); border-radius: 50px; height: 10px; position: relative; overflow: hidden; }
        .views-fill { background: linear-gradient(to right, #add8e6, #4169e1); border-radius: 50px; height: 100%; transition: width 0.8s ease; position: relative; }
        .views-fill::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .loading::after {
            content: ''; display: inline-block; width: 20px; height: 20px; border: 2px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; margin-left: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .pulse-dot {
            width: 10px; height: 10px; background: #4CAF50; border-radius: 50%;
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }
        .status-badge {
            padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; text-transform: uppercase;
        }
        .status-active { background: #4CAF50; color: white; }
        .status-pending { background: #FF9800; color: white; }
        .status-rejected { background: #f44336; color: white; }
        .status-expired { background: #9E9E9E; color: white; }
        .ad-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .ad-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(31, 38, 135, 0.6);
        }
        .view-counter {
            font-size: 32px;
            font-weight: bold;
            color: #add8e6;
            text-shadow: 0 0 10px rgba(173, 216, 230, 0.5);
        }
    </style>
</head>
<body class="min-h-screen text-white font-sans">
    <div class="nebula"></div>
    <div class="stars" id="stars"></div>
    <script>
        function createStars() {
            const starsDiv = document.getElementById('stars');
            for (let i = 0; i < 300; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = star.style.height = Math.random() * 3 + 1 + 'px';
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.animationDuration = Math.random() * 2 + 2 + 's';
                starsDiv.appendChild(star);
            }
        }
        createStars();
    </script>
    
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-8 glass-card p-6 rounded-2xl fade-in">
            <h1 class="text-5xl font-bold text-lightblue-300 mb-2" style="text-shadow: 0 0 15px rgba(173,216,230,0.5);">üé¨ MOOVIED Ads Dashboard</h1>
            <p class="text-gray-200 text-lg">Track Your Ad Performance in Real-Time</p>
        </header>

        <!-- Auth Modal -->
        <div id="authModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
            <div class="glass-card rounded-2xl p-8 w-full max-w-lg mx-4 fade-in">
                <div class="flex justify-end mb-4">
                    <button onclick="toggleAuth()" class="text-white hover:text-gray-300 text-3xl font-bold">&times;</button>
                </div>
                <h2 id="modalTitle" class="text-3xl font-bold mb-6 text-center text-lightblue-200">Login</h2>
                <form id="authForm">
                    <input type="hidden" id="action" value="login">
                    <div class="mb-4" id="nameField" style="display:none;">
                        <label class="block text-sm font-bold mb-2 text-gray-200">Full Name</label>
                        <input type="text" id="name" class="w-full p-3 rounded-lg glass text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="John Doe">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-gray-200">Email</label>
                        <input type="email" id="email" class="w-full p-3 rounded-lg glass text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="your@email.com" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-gray-200">Password</label>
                        <input type="password" id="password" class="w-full p-3 rounded-lg glass text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <div class="mb-4" id="phoneField" style="display:none;">
                        <label class="block text-sm font-bold mb-2 text-gray-200">Phone/WhatsApp</label>
                        <input type="tel" id="phone" class="w-full p-3 rounded-lg glass text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="+94770342724">
                    </div>
                    <button type="submit" id="authSubmit" class="w-full bg-blue-500 hover:bg-blue-600 p-3 rounded-lg font-bold transition duration-300 transform hover:scale-105">Login</button>
                </form>
                <p class="text-center mt-4 text-gray-300">
                    <button onclick="switchAuth()" class="text-lightblue-300 hover:underline font-bold">
                        <span id="switchText">Create New Account</span>
                    </button>
                </p>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden">
            <!-- Profile Header -->
            <div class="glass-card rounded-xl p-6 mb-6 flex flex-col md:flex-row items-center justify-between gap-4 fade-in">
                <div class="flex items-center gap-4">
                    <img id="profileImg" src="https://ui-avatars.com/api/?name=User&background=2196F3&color=fff&size=80" alt="Profile" class="w-20 h-20 rounded-full border-2 border-blue-500">
                    <div>
                        <h2 id="userName" class="text-2xl font-bold text-lightblue-200">User</h2>
                        <p id="userEmail" class="text-gray-300">email@example.com</p>
                        <p id="userPhone" class="text-gray-400 text-sm">Phone: Loading...</p>
                    </div>
                </div>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-6 py-2 rounded-lg transition duration-300 transform hover:scale-105">Logout</button>
            </div>

            <!-- Tabs -->
            <div class="glass-card rounded-xl p-6 mb-6 fade-in">
                <div class="flex flex-wrap border-b border-gray-600">
                    <button onclick="showTab('ads')" id="adsTabBtn" class="px-6 py-3 font-bold text-lightblue-300 border-b-2 border-lightblue-500 transition duration-300">üìä My Ads</button>
                    <button onclick="showTab('upload')" id="uploadTabBtn" class="px-6 py-3 font-bold text-gray-200 hover:text-lightblue-300 transition duration-300">‚¨ÜÔ∏è Upload Ad</button>
                    <button onclick="showTab('settings')" id="settingsTabBtn" class="px-6 py-3 font-bold text-gray-200 hover:text-lightblue-300 transition duration-300">‚öôÔ∏è Settings</button>
                </div>
            </div>

            <!-- Ads Tab -->
            <div id="adsTab" class="fade-in">
                <div class="glass-card rounded-xl p-6 mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-bold text-lightblue-200">Your Ads - Real-Time Views</h3>
                        <button onclick="refreshAds()" id="refreshBtn" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition duration-300 flex items-center gap-2">
                            <span>üîÑ</span> Refresh
                        </button>
                    </div>
                    <div id="adsStats" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="glass p-4 rounded-lg text-center">
                            <p class="text-gray-400 text-sm mb-1">Total Ads</p>
                            <p class="text-3xl font-bold text-lightblue-300" id="totalAds">0</p>
                        </div>
                        <div class="glass p-4 rounded-lg text-center">
                            <p class="text-gray-400 text-sm mb-1">Active Ads</p>
                            <p class="text-3xl font-bold text-green-400" id="activeAds">0</p>
                        </div>
                        <div class="glass p-4 rounded-lg text-center">
                            <p class="text-gray-400 text-sm mb-1">Total Views</p>
                            <p class="text-3xl font-bold text-yellow-400" id="totalViews">0</p>
                        </div>
                    </div>
                </div>
                <div id="adsList" class="space-y-6"></div>
            </div>

            <!-- Upload Tab -->
            <div id="uploadTab" class="glass-card rounded-xl p-6 hidden fade-in">
                <h3 class="text-2xl font-bold mb-6 text-lightblue-200">Upload New Ad</h3>
                <div class="bg-yellow-900 border border-yellow-500 rounded-lg p-4 mb-6">
                    <p class="text-yellow-200"><strong>‚ö†Ô∏è Important:</strong> After uploading, admin approval is required (24-48 hours). You'll receive email notification.</p>
                </div>
                <form id="uploadForm">
                    <div class="mb-6">
                        <label class="block text-sm font-bold mb-2 text-gray-200">Ad File (Video or Image)</label>
                        <input type="file" id="adFile" accept="video/*,image/*" class="w-full p-3 rounded-lg glass text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-500 file:text-white hover:file:bg-blue-600" required>
                        <p class="text-gray-400 text-sm mt-2">Max size: 50MB | Formats: MP4, JPG, PNG</p>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold mb-2 text-gray-200">Package</label>
                        <select id="expiryType" class="w-full p-3 rounded-lg glass text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="1month">üí∞ 1 Month - Rs 550</option>
                            <option value="12month">üíé 12 Months - Rs 5,000</option>
                            <option value="lifetime">üëë Lifetime - Rs 45,000</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold mb-2 text-gray-200">Bank Deposit Slip (Image)</label>
                        <input type="file" id="slipFile" accept="image/*" class="w-full p-3 rounded-lg glass text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-green-500 file:text-white hover:file:bg-green-600" required>
                        <p class="text-gray-400 text-sm mt-2">Upload payment confirmation slip</p>
                    </div>
                    <button type="submit" id="uploadSubmit" class="w-full bg-green-500 hover:bg-green-600 p-4 rounded-lg font-bold text-lg transition duration-300 transform hover:scale-105">
                        ‚¨ÜÔ∏è Upload & Submit for Approval
                    </button>
                </form>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="glass-card rounded-xl p-6 hidden fade-in">
                <h3 class="text-2xl font-bold mb-6 text-lightblue-200">Profile Settings</h3>
                <form id="settingsForm">
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-gray-200">Name</label>
                        <input type="text" id="editName" class="w-full p-3 rounded-lg glass text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-gray-200">Phone/WhatsApp</label>
                        <input type="tel" id="editPhone" class="w-full p-3 rounded-lg glass text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-2 text-gray-200">Profile Image</label>
                        <input type="file" id="profileFile" accept="image/*" class="w-full p-3 rounded-lg glass text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-purple-500 file:text-white hover:file:bg-purple-600">
                    </div>
                    <button type="submit" id="settingsSubmit" class="w-full bg-blue-500 hover:bg-blue-600 p-3 rounded-lg font-bold transition duration-300 transform hover:scale-105">üíæ Save Changes</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwHpgo8feCpO1v2s-FNp5Drj17IFvJ0YeOu1KDKBNWcDEdCTX_78b1o0dkdQ7o2CNJw/exec';
        const IMGBB_API = '912bd1391e9372f65c0918e17f0ed370';
        const REFRESH_INTERVAL = 10000; // 10 seconds
        
        let currentUser = { email: '', name: '', phone: '', deviceId: '' };
        let refreshTimer = null;

        async function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function toggleButtonLoading(buttonId, isLoading, text = '') {
            const button = document.getElementById(buttonId);
            if (isLoading) {
                button.disabled = true;
                button.classList.add('loading');
                button.dataset.originalText = button.textContent;
                button.textContent = text || 'Processing...';
            } else {
                button.disabled = false;
                button.classList.remove('loading');
                button.textContent = button.dataset.originalText || button.textContent;
            }
        }

        function getDeviceId() {
            let id = localStorage.getItem('moovied_device_id');
            if (!id) {
                id = btoa(navigator.userAgent + Date.now() + Math.random());
                localStorage.setItem('moovied_device_id', id);
            }
            return id;
        }

        async function checkSession() {
            const savedEmail = localStorage.getItem('moovied_user_email');
            if (savedEmail) {
                try {
                    const res = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: new URLSearchParams({ 
                            action: 'verify', 
                            email: savedEmail, 
                            deviceId: getDeviceId() 
                        })
                    });
                    const data = await res.json();
                    
                    if (data.success) {
                        currentUser = { ...data.user, deviceId: getDeviceId() };
                        loadUserData();
                        document.getElementById('dashboard').classList.remove('hidden');
                        document.getElementById('authModal').classList.add('hidden');
                    } else {
                        localStorage.removeItem('moovied_user_email');
                        showAuth();
                    }
                } catch (err) {
                    console.error('Session check failed:', err);
                    showAuth();
                }
            } else {
                showAuth();
            }
        }

        function showAuth() {
            document.getElementById('authModal').classList.remove('hidden');
        }

        function toggleAuth() {
            document.getElementById('authModal').classList.add('hidden');
        }

        function switchAuth() {
            const action = document.getElementById('action').value === 'login' ? 'signup' : 'login';
            document.getElementById('action').value = action;
            document.getElementById('modalTitle').textContent = action === 'login' ? 'Login' : 'Create Account';
            document.getElementById('nameField').style.display = action === 'signup' ? 'block' : 'none';
            document.getElementById('phoneField').style.display = action === 'signup' ? 'block' : 'none';
            document.getElementById('authSubmit').textContent = action === 'login' ? 'Login' : 'Sign Up';
            document.getElementById('switchText').textContent = action === 'login' ? 'Create New Account' : 'Already have account? Login';
        }

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleButtonLoading('authSubmit', true);
            
            const action = document.getElementById('action').value;
            const formData = new URLSearchParams({
                action,
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                phone: document.getElementById('phone').value,
                deviceId: getDeviceId()
            });

            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
                const data = await res.json();
                
                toggleButtonLoading('authSubmit', false);
                
                if (data.success) {
                    currentUser = { ...data.user, deviceId: getDeviceId() };
                    localStorage.setItem('moovied_user_email', currentUser.email);
                    loadUserData();
                    document.getElementById('dashboard').classList.remove('hidden');
                    toggleAuth();
                    
                    if (action === 'signup') {
                        alert('‚úÖ Account created successfully! Welcome to MOOVIED Ads.');
                    }
                } else {
                    alert('‚ùå ' + (data.message || 'Authentication failed'));
                }
            } catch (err) {
                toggleButtonLoading('authSubmit', false);
                alert('‚ùå Network error: ' + err.message);
            }
        });

        async function loadUserData() {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userPhone').textContent = 'Phone: ' + (currentUser.phone || 'Not set');
            
            if (currentUser.profileImg) {
                document.getElementById('profileImg').src = currentUser.profileImg;
            } else {
                document.getElementById('profileImg').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&background=2196F3&color=fff&size=80`;
            }
            
            document.getElementById('editName').value = currentUser.name;
            document.getElementById('editPhone').value = currentUser.phone || '';
            
            await loadAds();
            startAutoRefresh();
        }

        async function loadAds() {
            const formData = new URLSearchParams({ action: 'get_ads', email: currentUser.email });
            
            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
                const data = await res.json();
                
                const list = document.getElementById('adsList');
                const ads = data.ads || [];
                
                // Update stats
                document.getElementById('totalAds').textContent = ads.length;
                document.getElementById('activeAds').textContent = ads.filter(ad => ad.Status === 'active').length;
                document.getElementById('totalViews').textContent = ads.reduce((sum, ad) => sum + (ad.Views || 0), 0).toLocaleString();
                
                if (ads.length === 0) {
                    list.innerHTML = `
                        <div class="glass-card p-8 text-center">
                            <p class="text-gray-400 text-lg mb-4">üì≠ No ads uploaded yet</p>
                            <button onclick="showTab('upload')" class="bg-blue-500 hover:bg-blue-600 px-6 py-3 rounded-lg transition duration-300">Upload Your First Ad</button>
                        </div>
                    `;
                } else {
                    list.innerHTML = ads.map(ad => {
                        const viewPercentage = Math.min((ad.Views / 10000) * 100, 100);
                        const statusClass = `status-${ad.Status}`;
                        const expiryDate = new Date(ad.ExpiryDate);
                        const daysLeft = Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24));
                        
                        return `
                            <div class="glass-card p-6 ad-card">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <p class="text-xl font-bold text-lightblue-200">${ad.AdType.toUpperCase()} Ad - ID: ${ad.ID}</p>
                                        <p class="text-gray-400 text-sm">Created: ${new Date(ad.CreatedDate).toLocaleDateString()}</p>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="status-badge ${statusClass}">${ad.Status}</span>
                                        ${ad.Status === 'active' ? '<div class="pulse-dot"></div>' : ''}
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                    <div class="glass p-4 rounded-lg text-center">
                                        <p class="text-gray-400 text-sm mb-1">Views</p>
                                        <p class="view-counter">${ad.Views.toLocaleString()}</p>
                                    </div>
                                    <div class="glass p-4 rounded-lg text-center">
                                        <p class="text-gray-400 text-sm mb-1">Package</p>
                                        <p class="text-lg font-bold text-yellow-400">${ad.ExpiryType === '1month' ? '1 Month' : ad.ExpiryType === '12month' ? '12 Months' : 'Lifetime'}</p>
                                    </div>
                                    <div class="glass p-4 rounded-lg text-center">
                                        <p class="text-gray-400 text-sm mb-1">Days Left</p>
                                        <p class="text-lg font-bold ${daysLeft > 30 ? 'text-green-400' : daysLeft > 7 ? 'text-yellow-400' : 'text-red-400'}">${daysLeft > 0 ? daysLeft : 'Expired'}</p>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <div class="flex justify-between text-sm text-gray-400 mb-2">
                                        <span>View Progress</span>
                                        <span>${viewPercentage.toFixed(1)}%</span>
                                    </div>
                                    <div class="views-progress">
                                        <div class="views-fill" style="width: ${viewPercentage}%"></div>
                                    </div>
                                </div>
                                
                                <div class="flex flex-wrap gap-2">
                                    ${ad.Status === 'pending' ? `
                                        <button onclick="contactSupport('${ad.ID}')" class="bg-orange-500 hover:bg-orange-600 px-4 py-2 rounded-lg transition duration-300">üìû Contact Support</button>
                                    ` : ''}
                                    ${ad.Status === 'active' && ad.CloudinaryUrl ? `
                                        <a href="${ad.CloudinaryUrl}" target="_blank" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg transition duration-300 inline-block">üëÅÔ∏è View Ad</a>
                                    ` : ''}
                                    <p class="text-gray-400 text-sm flex items-center">
                                        Expires: ${expiryDate.toLocaleDateString()}
                                    </p>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (err) {
                console.error('Load ads error:', err);
                document.getElementById('adsList').innerHTML = `
                    <div class="glass-card p-8 text-center">
                        <p class="text-red-400 mb-4">‚ùå Failed to load ads</p>
                        <button onclick="loadAds()" class="bg-blue-500 hover:bg-blue-600 px-6 py-3 rounded-lg transition duration-300">Retry</button>
                    </div>
                `;
            }
        }

        function startAutoRefresh() {
            if (refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(() => {
                if (document.getElementById('adsTab').style.display !== 'none') {
                    loadAds();
                }
            }, REFRESH_INTERVAL);
        }

        async function refreshAds() {
            toggleButtonLoading('refreshBtn', true, 'üîÑ Refreshing...');
            await loadAds();
            toggleButtonLoading('refreshBtn', false);
        }

        function contactSupport(adId) {
            window.open(`https://wa.me/94770342724?text=Hi%2C%20I%20need%20support%20for%20Ad%20ID%3A%20${adId}`);
        }

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const adFile = document.getElementById('adFile').files[0];
            const slipFile = document.getElementById('slipFile').files[0];
            const expiryType = document.getElementById('expiryType').value;

            if (!adFile || !slipFile) {
                alert('‚ùå Please select both ad and payment slip files');
                return;
            }

            if (adFile.size > 50 * 1024 * 1024) {
                alert('‚ùå Ad file is too large. Maximum size is 50MB');
                return;
            }

            toggleButtonLoading('uploadSubmit', true, '‚¨ÜÔ∏è Uploading...');

            try {
                const adBase64 = await fileToBase64(adFile);
                const slipBase64 = await fileToBase64(slipFile);

                const formData = new URLSearchParams({
                    action: 'upload_ad',
                    email: currentUser.email,
                    adFileBase64: adBase64,
                    slipFileBase64: slipBase64,
                    adFileName: adFile.name,
                    slipFileName: slipFile.name,
                    expiryType
                });

                const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
                const data = await res.json();

                toggleButtonLoading('uploadSubmit', false);

                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    document.getElementById('uploadForm').reset();
                    showTab('ads');
                    await loadAds();
                } else {
                    alert('‚ùå ' + (data.message || 'Upload failed'));
                }
            } catch (err) {
                toggleButtonLoading('uploadSubmit', false);
                alert('‚ùå Upload error: ' + err.message);
            }
        });

        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleButtonLoading('settingsSubmit', true, 'üíæ Saving...');

            const profileFile = document.getElementById('profileFile').files[0];
            let imgUrl = currentUser.profileImg;

            if (profileFile) {
                try {
                    const formData = new FormData();
                    formData.append('image', profileFile);
                    formData.append('key', IMGBB_API);

                    const res = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: formData });
                    const data = await res.json();
                    
                    if (data.success) {
                        imgUrl = data.data.url;
                    } else {
                        throw new Error('Image upload failed');
                    }
                } catch (err) {
                    toggleButtonLoading('settingsSubmit', false);
                    alert('‚ùå Profile image upload failed: ' + err.message);
                    return;
                }
            }

            const formData = new URLSearchParams({
                action: 'update_profile',
                email: currentUser.email,
                name: document.getElementById('editName').value,
                phone: document.getElementById('editPhone').value,
                profileImg: imgUrl
            });

            try {
                const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
                const data = await res.json();

                toggleButtonLoading('settingsSubmit', false);

                if (data.success) {
                    currentUser = { ...currentUser, ...data.user };
                    loadUserData();
                    alert('‚úÖ Profile updated successfully!');
                } else {
                    alert('‚ùå Update failed');
                }
            } catch (err) {
                toggleButtonLoading('settingsSubmit', false);
                alert('‚ùå Update error: ' + err.message);
            }
        });

        function showTab(tab) {
            document.querySelectorAll('[id$="Tab"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(tab + 'Tab').classList.remove('hidden');
            
            document.querySelectorAll('[id$="TabBtn"]').forEach(btn => {
                btn.classList.remove('text-lightblue-300', 'border-b-2', 'border-lightblue-500');
                btn.classList.add('text-gray-200');
            });
            
            const activeBtn = document.getElementById(tab + 'TabBtn');
            activeBtn.classList.add('text-lightblue-300', 'border-b-2', 'border-lightblue-500');
            activeBtn.classList.remove('text-gray-200');
            
            if (tab === 'ads') {
                loadAds();
                startAutoRefresh();
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('moovied_user_email');
                if (refreshTimer) clearInterval(refreshTimer);
                currentUser = {};
                document.getElementById('dashboard').classList.add('hidden');
                showAuth();
            }
        }

        checkSession();
    </script>
</body>
</html>
